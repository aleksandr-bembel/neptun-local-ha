# –ü—Ä–∏–º–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π –¥–ª—è Neptun Leak Protection

# –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è: –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–ª–∞–ø–∞–Ω–∞ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ—Ç–µ—á–∫–∏
automation:
  - alias: "–ó–∞–∫—Ä—ã—Ç—å –∫–ª–∞–ø–∞–Ω –ø—Ä–∏ –ø—Ä–æ—Ç–µ—á–∫–µ"
    description: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–π –∫–ª–∞–ø–∞–Ω –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ—Ç–µ—á–∫–∏ –ª—é–±—ã–º –¥–∞—Ç—á–∏–∫–æ–º"
    trigger:
      - platform: state
        entity_id: 
          - binary_sensor.neptun_device_wireless_sensor_1_leak
          - binary_sensor.neptun_device_wireless_sensor_2_leak
          - binary_sensor.neptun_device_wireless_sensor_3_leak
        to: "on"
    condition:
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —Å—É—Ö–æ–≥–æ —Ö–æ–¥–∞
      - condition: state
        entity_id: switch.neptun_device_dry_mode
        state: "off"
    action:
      - service: switch.turn_off
        target:
          entity_id: switch.neptun_device_valve
      - service: notify.mobile_app_your_phone
        data:
          title: "üö® –ü–†–û–¢–ï–ß–ö–ê –í–û–î–´!"
          message: "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ—Ç–µ—á–∫–∞! –ö–ª–∞–ø–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç."
          data:
            priority: high
            ttl: 0

  # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∏–∑–∫–æ–º –∑–∞—Ä—è–¥–µ –±–∞—Ç–∞—Ä–µ–∏
  - alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∏–∑–∫–æ–º –∑–∞—Ä—è–¥–µ –±–∞—Ç–∞—Ä–µ–∏ –¥–∞—Ç—á–∏–∫–∞"
    description: "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –∑–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏ –±–µ—Å–ø—Ä–æ–≤–æ–¥–Ω–æ–≥–æ –¥–∞—Ç—á–∏–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–∏–∑–∫–∏–º"
    trigger:
      - platform: numeric_state
        entity_id: 
          - sensor.neptun_device_wireless_sensor_1_battery
          - sensor.neptun_device_wireless_sensor_2_battery
          - sensor.neptun_device_wireless_sensor_3_battery
        below: 20
    action:
      - service: notify.mobile_app_your_phone
        data:
          title: "üîã –ù–∏–∑–∫–∏–π –∑–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏"
          message: "–ó–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏ –¥–∞—Ç—á–∏–∫–∞ {{ trigger.to_state.attributes.friendly_name }} —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç {{ trigger.to_state.state }}%"

  # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è: –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã
  - alias: "–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∑–∞—â–∏—Ç—ã"
    description: "–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç"
    trigger:
      - platform: time
        at: "09:00:00"
      - platform: time
        at: "09:00:00"
    condition:
      - condition: time
        weekday:
          - sun
    action:
      - service: notify.mobile_app_your_phone
        data:
          title: "üìä –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Å–∏—Å—Ç–µ–º—ã –∑–∞—â–∏—Ç—ã"
          message: >
            –ö–ª–∞–ø–∞–Ω: {{ states('switch.equation_device_192_168_1_100_valve') }}
            –°–∏—Å—Ç–µ–º–∞: {{ states('binary_sensor.equation_device_192_168_1_100_alarm') }}
            –°—á–µ—Ç—á–∏–∫: {{ states('sensor.equation_device_192_168_1_100_line_0_water') }} –º¬≥

  # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ —Å—É—Ö–æ–≥–æ —Ä–µ–∂–∏–º–∞
  - alias: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å—É—Ö–æ–π —Ä–µ–∂–∏–º –ø—Ä–∏ —É–±–æ—Ä–∫–µ"
    description: "–í–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º —Å—É—Ö–æ–≥–æ —Ö–æ–¥–∞ –∫–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —É–±–æ—Ä–∫–∞"
    trigger:
      - platform: state
        entity_id: input_boolean.cleaning_mode
        to: "on"
    action:
      - service: switch.turn_on
        target:
          entity_id: switch.equation_device_192_168_1_100_dry_mode
      - service: notify.mobile_app_your_phone
        data:
          title: "üßΩ –†–µ–∂–∏–º —É–±–æ—Ä–∫–∏"
          message: "–í–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —Å—É—Ö–æ–≥–æ —Ö–æ–¥–∞. –î–∞—Ç—á–∏–∫–∏ –ø—Ä–æ—Ç–µ—á–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω—ã."

  # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å—É—Ö–æ–≥–æ —Ä–µ–∂–∏–º–∞
  - alias: "–û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å—É—Ö–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø–æ—Å–ª–µ —É–±–æ—Ä–∫–∏"
    description: "–û—Ç–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º —Å—É—Ö–æ–≥–æ —Ö–æ–¥–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É–±–æ—Ä–∫–∏"
    trigger:
      - platform: state
        entity_id: input_boolean.cleaning_mode
        to: "off"
        for: "00:05:00"  # 5 –º–∏–Ω—É—Ç –∑–∞–¥–µ—Ä–∂–∫–∏
    action:
      - service: switch.turn_off
        target:
          entity_id: switch.equation_device_192_168_1_100_dry_mode
      - service: notify.mobile_app_your_phone
        data:
          title: "‚úÖ –†–µ–∂–∏–º —É–±–æ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω"
          message: "–†–µ–∂–∏–º —Å—É—Ö–æ–≥–æ —Ö–æ–¥–∞ –æ—Ç–∫–ª—é—á–µ–Ω. –°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –∞–∫—Ç–∏–≤–Ω–∞."

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä—ã –∏ —à–∞–±–ª–æ–Ω—ã
template:
  # –®–∞–±–ª–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã
  - binary_sensor:
      - name: "–°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –∞–∫—Ç–∏–≤–Ω–∞"
        unique_id: equation_protection_active
        state: >
          {{ is_state('switch.equation_device_192_168_1_100_valve', 'on') and
             is_state('binary_sensor.equation_device_192_168_1_100_alarm', 'off') }}
        icon: >
          {% if is_state('binary_sensor.equation_protection_active', 'on') %}
            mdi:shield-check
          {% else %}
            mdi:shield-alert
          {% endif %}

  # –®–∞–±–ª–æ–Ω –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤ –ø—Ä–æ—Ç–µ—á–∫–∏
  - sensor:
      - name: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤ –ø—Ä–æ—Ç–µ—á–∫–∏"
        unique_id: equation_active_leak_sensors
        state: >
          {% set leak_sensors = [
            'binary_sensor.equation_device_192_168_1_100_line_0_leak',
            'binary_sensor.equation_device_192_168_1_100_line_1_leak',
            'binary_sensor.equation_device_192_168_1_100_wireless_4_leak'
          ] %}
          {{ leak_sensors | select('is_state', 'on') | list | count }}
        icon: mdi:water-alert

  # –®–∞–±–ª–æ–Ω –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–≥–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –≤–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü
  - sensor:
      - name: "–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –≤–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü"
        unique_id: equation_monthly_water_usage
        state: >
          {% set current = states('sensor.equation_device_192_168_1_100_line_0_water') | float(0) %}
          {% set last_month = state_attr('sensor.equation_monthly_water_usage', 'last_month_value') | float(current) %}
          {{ (current - last_month) | round(2) }}
        unit_of_measurement: "m¬≥"
        device_class: water
        state_class: measurement
        attributes:
          last_month_value: >
            {% if now().day == 1 %}
              {{ states('sensor.equation_device_192_168_1_100_line_0_water') | float(0) }}
            {% else %}
              {{ state_attr('sensor.equation_monthly_water_usage', 'last_month_value') | float(0) }}
            {% endif %}

# –ì—Ä—É–ø–ø—ã –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π
group:
  equation_leak_protection:
    name: "–ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ—Ç–µ—á–µ–∫"
    icon: mdi:water-pump
    entities:
      - switch.equation_device_192_168_1_100_valve
      - switch.equation_device_192_168_1_100_dry_mode
      - binary_sensor.equation_device_192_168_1_100_alarm
      - binary_sensor.equation_protection_active

  equation_leak_sensors:
    name: "–î–∞—Ç—á–∏–∫–∏ –ø—Ä–æ—Ç–µ—á–∫–∏"
    icon: mdi:water-alert
    entities:
      - binary_sensor.equation_device_192_168_1_100_line_0_leak
      - binary_sensor.equation_device_192_168_1_100_line_1_leak
      - binary_sensor.equation_device_192_168_1_100_wireless_4_leak

  equation_water_counters:
    name: "–°—á–µ—Ç—á–∏–∫–∏ –≤–æ–¥—ã"
    icon: mdi:counter
    entities:
      - sensor.equation_device_192_168_1_100_line_0_water
      - sensor.equation_monthly_water_usage

  equation_wireless_diagnostics:
    name: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–µ—Å–ø—Ä–æ–≤–æ–¥–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤"
    icon: mdi:wifi
    entities:
      - sensor.equation_device_192_168_1_100_wireless_4_battery
      - sensor.equation_device_192_168_1_100_wireless_4_signal

# –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
script:
  equation_emergency_shutdown:
    alias: "–≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤–æ–¥—ã"
    description: "–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∫–ª–∞–ø–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
    sequence:
      - service: switch.turn_off
        target:
          entity_id: switch.equation_device_192_168_1_100_valve
      - service: notify.mobile_app_your_phone
        data:
          title: "üö® –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ"
          message: "–í–æ–¥—è–Ω–æ–π –∫–ª–∞–ø–∞–Ω –∑–∞–∫—Ä—ã—Ç –≤—Ä—É—á–Ω—É—é"

  equation_system_check:
    alias: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã"
    description: "–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã"
    sequence:
      - service: homeassistant.update_entity
        target:
          entity_id: 
            - switch.equation_device_192_168_1_100_valve
            - binary_sensor.equation_device_192_168_1_100_alarm
      - delay: "00:00:02"
      - service: notify.mobile_app_your_phone
        data:
          title: "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã"
          message: >
            –°—Ç–∞—Ç—É—Å: {% if is_state('binary_sensor.equation_protection_active', 'on') %}–ê–∫—Ç–∏–≤–Ω–∞{% else %}–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è{% endif %}
            –ö–ª–∞–ø–∞–Ω: {{ states('switch.equation_device_192_168_1_100_valve') }}
            –¢—Ä–µ–≤–æ–≥–∞: {{ states('binary_sensor.equation_device_192_168_1_100_alarm') }}
